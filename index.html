<!doctype html>
<html lang="en">
<head>
<!-- BUILD-MARKER: v48 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Thumbs Down Â· v48</title>
<meta name="theme-color" content="#111111"/>

<!-- Social preview -->
<meta property="og:title" content="Thumbs Down" />
<meta property="og:description" content="Tap fast. Last one down faces a task." />
<meta property="og:type" content="website" />
<meta property="og:image" content="/Thumbs Down.png" />
<meta property="og:url" content="https://thumbsdown.netlify.app/" />

<style>
:root{
--cream:#F7F1E6;
--ink:#0F0F10;
--box:#111214;
--accent-2:#1b1d20;
--radius:16px;

--grey:#cfd3d9;
--red:#e53935;
--amber:#ffb300;
--green:#2e7d32;

/* emoji colorizing (approx) */
--grey-filter: grayscale(1) brightness(.9);
--red-filter: hue-rotate(-10deg) saturate(1.5) brightness(1);
--amber-filter: hue-rotate(25deg) saturate(1.7) brightness(1.05);
--green-filter: hue-rotate(95deg) saturate(1.2) brightness(1.05);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
margin:0;
font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
background:var(--cream);
color:var(--ink);
-webkit-font-smoothing:antialiased;
-moz-osx-font-smoothing:grayscale;
}

/* Header / logo row (same layout/feel) */
header{
max-width:680px; margin:16px auto 10px; padding:0 16px;
display:flex; align-items:flex-end; gap:14px; flex-wrap:nowrap;
}
.logo-mark{ font-size:36px; line-height:1; transform:rotate(180deg); filter:var(--green-filter); }
.title-wrap{ display:flex; flex-direction:column; gap:6px; min-width:0; flex:1; }
.brand{ display:flex; align-items:baseline; gap:10px; white-space:nowrap; overflow:hidden; }
.brand h1{ margin:0; font-weight:800; letter-spacing:.2px; font-size:clamp(22px, 6.3vw, 34px); }
.tag{ margin:0; color:#2b2e31; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; font-style:italic; font-size:clamp(13px, 3.2vw, 16px); text-align:right; opacity:.9; }

/* Main card */
.card{
max-width:680px; margin:0 auto 18px;
background:linear-gradient(180deg, var(--box), var(--accent-2)); color:#fff;
border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.25); padding:16px;
}

/* Host setup */
.hint{color:#d0d3d8;font-size:13px;margin:4px 0 10px}
.names-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
.names-grid input{
width:100%; border-radius:10px; background:#1a1c20; color:#fff;
border:1px solid #2b2d31; padding:10px 12px; font-size:15px;
}
.row{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; }
.btn{ appearance:none; border:0; border-radius:10px; padding:10px 14px; font-weight:700; font-size:14px; cursor:pointer; }
.btn.primary{ background:#21c063; color:#05230f; }
.btn.ghost{ background:#24262b; color:#e6e8ec; }
.btn.small{ padding:8px 12px; font-size:13px }

/* Table */
.table-area{ margin-top:12px; }
.thumbs{ display:grid; grid-template-columns:repeat(5,1fr); gap:8px; justify-items:center; align-items:center; }
.person{ display:flex; flex-direction:column; align-items:center; gap:2px; }
.name{ margin-top:4px; font-size:12px; color:#cfd3d9; text-align:center; width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

.thumb{
font-size:34px; line-height:1; background:transparent; border:0; cursor:pointer;
transition: transform .22s ease, opacity .2s ease, filter .15s ease;
filter: drop-shadow(0 1px 0 rgba(0,0,0,.35));
}
.thumb.up { transform:none; filter:var(--grey-filter) drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
.thumb.down-r { transform:rotate(180deg); filter:var(--red-filter) drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
.thumb.down-a { transform:rotate(180deg); filter:var(--amber-filter)drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
.thumb.down-g { transform:rotate(180deg); filter:var(--green-filter)drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
.thumb.locked { opacity:.65; cursor:default }

@keyframes wobble { 0%{transform:translateX(0)} 25%{transform:translateX(-4px) rotate(180deg)} 75%{transform:translateX(4px) rotate(180deg)} 100%{transform:translateX(0) rotate(180deg)} }
.wobble{ animation:wobble .25s linear 1; }

/* Punisher modal */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:flex-end; justify-content:center; padding:16px; }
.modal.show{ display:flex }
.sheet{ width:100%; max-width:680px; background:#0f1013; color:#fff; border-radius:16px 16px 12px 12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.45); }
.sheet h3{ margin:0 0 8px; font-size:18px }
.sheet p{ margin:0 0 10px; color:#cdd2d8; font-size:14px }
.sheet textarea{ width:100%; min-height:80px; background:#181a1e; border:1px solid #2a2c31; color:#fff; border-radius:12px; padding:10px; font-size:14px; }
.actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }

/* Toast */
#toast{ position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:#111; color:#fff; padding:8px 12px; border-radius:8px; opacity:0; pointer-events:none; transition:opacity .2s }
#toast.show{ opacity:.95 }

/* Small screens */
@media (max-width:400px){
.names-grid{ grid-template-columns:1fr }
.thumbs{ grid-template-columns:repeat(4,1fr) }
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
<div class="logo-mark" aria-hidden="true">ðŸ‘Ž</div>
<div class="title-wrap">
<div class="brand"><h1>THUMBS&nbsp;DOWN</h1></div>
<p class="tag">Tap fast. Last one down faces a task. Â· <span id="vtag">v48</span></p>
</div>
</header>

<!-- CARD -->
<main class="card">
<!-- HOST SETUP -->
<div id="host-setup">
<div class="hint">Add up to 10 friends</div>
<div class="names-grid" id="nameInputs"></div>
<div class="row">
<button class="btn ghost small" id="resetBtn" type="button" aria-label="Reset">Reset</button>
<button class="btn primary small" id="confirmBtn" type="button" aria-label="Confirm">Confirm</button>
</div>
</div>

<!-- TABLE -->
<div class="table-area" id="tableArea" hidden>
<div class="thumbs" id="thumbs"></div>
</div>
</main>

<!-- PUNISHER MODAL -->
<div class="modal" id="punisherModal" aria-hidden="true">
<div class="sheet" role="dialog" aria-modal="true" aria-labelledby="punishTitle">
<h3 id="punishTitle">Congratulations â€” youâ€™re the Punisher</h3>
<p id="punishText">The person who didnâ€™t tap their name is <strong id="loserName">TBD</strong> and must face a task. Now set their dare or task below.</p>
<textarea id="dareText" maxlength="200" placeholder="Type the dare or task (max 200 chars)"></textarea>
<div class="actions">
<button class="btn ghost" id="closePunisher" type="button">Cancel</button>
<button class="btn primary" id="sharePunisher" type="button">Share back to your group</button>
</div>
</div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ---------- tiny helpers ----------
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const sleep = ms => new Promise(r => setTimeout(r, ms));
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }

// persistent device id (one tap per device per game)
function getClientId(){
const k='td-client-id';
let v=localStorage.getItem(k);
if(!v){ v=(crypto.randomUUID?crypto.randomUUID(): Date.now()+Math.random().toString(36).slice(2)); localStorage.setItem(k,v); }
return v;
}
const clientId = getClientId();

// make 10 inputs (no validation attributes -> no browser pattern errors)
const nameInputsEl = $("#nameInputs");
for (let i=0;i<10;i++){
const inp = document.createElement('input');
inp.type = 'text'; // no pattern, no required
inp.inputMode = 'text';
inp.placeholder = `Name ${i+1}`;
inp.autocapitalize = 'words';
nameInputsEl.appendChild(inp);
}

// ---- network wrappers (align with your functions) ----
async function apiCreate(names){
const r = await fetch('/api/game',{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({names})});
const d = await r.json(); if(!r.ok) throw new Error(d.error||'create failed'); return d;
}
async function apiState(gameId){
const r = await fetch(`/api/state?gameId=${encodeURIComponent(gameId)}`);
const d = await r.json(); if(!r.ok) throw new Error(d.error||'state failed'); return d;
}
async function apiTap(gameId,name){
const r = await fetch('/api/tap',{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({gameId,name,clientId})});
const d = await r.json(); if(!r.ok) throw new Error(d.error||'tap failed'); return d;
}
async function apiConfirmTap(gameId,name){
const r = await fetch('/api/confirmTap',{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({gameId,name,clientId})});
const d = await r.json(); if(!r.ok) throw new Error(d.error||'confirmTap failed'); return d;
}
async function apiReveal(gameId,dare){
const r = await fetch('/api/reveal',{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({gameId,dare})});
const d = await r.json(); if(!r.ok) throw new Error(d.error||'reveal failed'); return d;
}
async function apiConfirmReveal(gameId){
const r = await fetch('/api/confirmReveal',{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({gameId})});
const d = await r.json(); if(!r.ok) throw new Error(d.error||'confirmReveal failed'); return d;
}

// ---- state ----
let current = null; // { gameId, names, tapped:[], confirmed:[], loser?, dare? }

// ---- UI render ----
function render(state){
current = state;
$("#tableArea").hidden = false;

const wrap = $("#thumbs");
wrap.innerHTML = '';

state.names.forEach(n=>{
const cell = document.createElement('div'); cell.className='person';

// decide visual state
const isConfirmed = (state.confirmed||[]).includes(n);
const isTapped = (state.tapped||[]).includes(n);
const btn = document.createElement('button'); btn.type='button'; btn.className='thumb';

if(isConfirmed){ btn.textContent='ðŸ‘Ž'; btn.classList.add('down-g'); btn.classList.add('locked'); }
else if(isTapped){ btn.textContent='ðŸ‘Ž'; btn.classList.add('down-r'); }
else { btn.textContent='ðŸ‘'; btn.classList.add('up'); }

btn.addEventListener('click', ()=> onTap(n, btn));

const label = document.createElement('div'); label.className='name'; label.textContent=n;
cell.appendChild(btn); cell.appendChild(label);
wrap.appendChild(cell);
});

applyDeviceLock(state.gameId);
}

function applyDeviceLock(gameId){
const confirmedName = localStorage.getItem(`td-lock-${gameId}`);
if(confirmedName){
// Fully lock all thumbs; but let only confirmed one stay green; others wobble on attempt
$$('.thumb').forEach((b,idx)=>{
b.disabled = false; // keep clickable solely to wobble feedback
b.addEventListener('click', (e)=>{
if(!b.classList.contains('down-g')){ b.classList.add('wobble'); setTimeout(()=>b.classList.remove('wobble'),250); }
}, { once:true });
});
}
}

// ---- actions ----
$("#confirmBtn").addEventListener('click', async ()=>{
try{
const names = [...nameInputsEl.querySelectorAll('input')].map(i=>i.value.trim()).filter(Boolean).slice(0,10);
if(names.length<3){ toast('Add at least 3 names'); return; }
const { gameId, state } = await apiCreate(names);
$("#host-setup").style.display='none';
render(state);
toast('Game created. Tap your name to start!');
history.replaceState(null,'',`/?g=${encodeURIComponent(gameId)}`);
}catch(e){ toast(e.message); }
});

$("#resetBtn").addEventListener('click', ()=>{
[...nameInputsEl.querySelectorAll('input')].forEach(i=> i.value='');
localStorage.clear();
location.href='/';
});

async function onTap(name, el){
if(!current) return;
const gameId = current.gameId;

// if already confirmed on this device, don't allow
if(localStorage.getItem(`td-lock-${gameId}`)){ el.classList.add('wobble'); setTimeout(()=>el.classList.remove('wobble'),250); return; }

try{
// send initial tap -> server marks "tapped" (red)
await apiTap(gameId, name);
el.textContent='ðŸ‘Ž'; el.className='thumb down-r';

// Open share; while open, show amber
await sleep(80);
el.className='thumb down-a';

const shareText = `I tapped in Thumbs Down! (game ${gameId})`;
const url = location.origin + `/?g=${encodeURIComponent(gameId)}`;

// Try native share, fallback to WhatsApp
if(navigator.share){
await navigator.share({ title:'Thumbs Down', text:shareText, url });
}else{
const wa = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + url)}`;
window.location.href = wa;
// user returns afterwards
}

// After share, confirm on server -> turn green & lock this device
const state = await apiConfirmTap(gameId, name);
render(state);
localStorage.setItem(`td-lock-${gameId}`, name);

// If only one remains, prep punisher
const remaining = state.names.filter(n=>!(state.confirmed||[]).includes(n));
if(remaining.length===1){
const loser = remaining[0];
$("#loserName").textContent = loser;
$("#punisherModal").classList.add('show');
$("#punisherModal").setAttribute('aria-hidden','false');
}

}catch(e){
toast(e.message||'Tap failed');
// revert visual if needed
if(el.classList.contains('down-a')){ el.className='thumb down-r'; }
}
}

// Punisher modal actions
$("#closePunisher").addEventListener('click', ()=>{
$("#punisherModal").classList.remove('show');
$("#punisherModal").setAttribute('aria-hidden','true');
});

$("#sharePunisher").addEventListener('click', async ()=>{
if(!current) return;
const dare = ($("#dareText").value || '').trim();
try{
const revealed = await apiReveal(current.gameId, dare);

// Build WhatsApp / share text
const url = location.origin + `/?g=${encodeURIComponent(revealed.gameId)}&reveal=1`;
let text = `Thumbs Down â€” result:\n\nLoser: ${revealed.loser || 'unknown'}\nTask: ${revealed.dare || '(none)'}\n\nOpen: ${url}`;

if(navigator.share){
await navigator.share({ title:'Thumbs Down', text: text });
}else{
const wa = `https://wa.me/?text=${encodeURIComponent(text)}`;
location.href = wa;
}

// confirm reveal after sharing
const state = await apiConfirmReveal(revealed.gameId);
$("#punisherModal").classList.remove('show');
$("#punisherModal").setAttribute('aria-hidden','true');
render(state);

}catch(e){ toast(e.message); }
});

// ---- hydration on load ----
(async function init(){
const params = new URLSearchParams(location.search);
const g = params.get('g');
if(g){
$("#host-setup").style.display='none';
try{
const state = await apiState(g);
render(state);
}catch(e){ toast(e.message); }
}
// show version in UI (helps you confirm deploy)
const vqs = [...params.entries()].find(([k])=>k==='v');
if(vqs){ $("#vtag").textContent = `v48 â€¢ ${vqs[1]}`; }
})();
</script>
</body>
</html>
